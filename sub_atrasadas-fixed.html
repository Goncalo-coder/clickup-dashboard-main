<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš ï¸ Subtarefas Atrasadas</title>

<style>
body{font-family:Arial;background:#f7f8fa;padding:20px}
.container{max-width:1200px;margin:auto}
.card{background:#fff0f0;padding:15px;margin:10px 0;border-radius:6px}
.btn{padding:6px 12px;background:#333;color:white;border:none;border-radius:4px}
</style>
</head>

<body>

<button class="btn" onclick="openConfig()">âš™ï¸ Configurar</button>

<div class="container">
<h1>âš ï¸ Subtarefas Atrasadas</h1>

<div id="loading">A carregarâ€¦</div>
<div id="content"></div>
<div id="error" style="color:red"></div>
</div>

<div id="config" style="display:none">
<input id="token" placeholder="pk_..." type="password">
<button onclick="save()">Guardar</button>
</div>

<script>

const TEAM_ID="278548639";

function openConfig(){
 document.getElementById("config").style.display="block";
}

function save(){
 localStorage.setItem("clickup_api_token",document.getElementById("token").value);
 location.reload();
}

async function load(){

 const token=localStorage.getItem("clickup_api_token");
 if(!token){openConfig();return;}

 try{

 const res=await fetch(
  `https://api.clickup.com/api/v2/team/${TEAM_ID}/task`,
 {
  headers:{Authorization:token}
 });

 if(!res.ok) throw new Error(res.status);

 const data=await res.json();

 const today=new Date().setHours(0,0,0,0);

 const list=data.tasks.filter(t=>{
  if(!t.due_date) return false;
  if(!t.parent) return false;

  return Number(t.due_date)<today;
 });

 let html="";

 if(list.length===0){
  html="<h3>ğŸ‰ Nenhuma atrasada</h3>";
 }

 list.forEach(t=>{

  const days=Math.ceil(
   (today-Number(t.due_date))/(1000*60*60*24)
  );

  html+=`
  <div class="card">
   <b>${t.name}</b><br>
   Atraso: ${days} dias<br>
   <a href="${t.url}" target="_blank">Abrir</a>
  </div>`;
 });

 document.getElementById("content").innerHTML=html;
 document.getElementById("loading").style.display="none";

 }catch(e){
  document.getElementById("error").innerText="Erro API: "+e;
 }
}

load();
setInterval(load,300000);

</script>
</body>
</html>
